# Web Capture - State Management Bug Fixes

> **–î–∞—Ç–∞:** 13 –¥–µ–∫–∞–±—Ä—è 2025
> **–í–µ—Ä—Å–∏—è:** 1.3
> **–°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –±–∞–≥–∏

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä—É—á–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:

### –ë–∞–≥ #1: –ö–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≥–∞–ª–µ—Ä–µ–∏ ‚ùå

**–û–ø–∏—Å–∞–Ω–∏–µ:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
2. –ù–∞—Ö–æ–¥—è—Ç—Å—è –≤–µ—â–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è gallery sheet
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç gallery sheet
4. **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–Ω–æ–ø–∫–∞ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –∏—Å—á–µ–∑–∞–µ—Ç –∏ –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:**

```typescript
// DetectionFAB.tsx (—Å—Ç–∞—Ä—ã–π –∫–æ–¥)
if (hasScanned && detectedImages.length > 0 && !isScanning) {
  return null; // –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞ –Ω–∞–≤—Å–µ–≥–¥–∞
}
```

–£—Å–ª–æ–≤–∏–µ —Å–∫—Ä—ã–≤–∞–ª–æ –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ `hasScanned === true` –∏ –µ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –æ—Ç–∫—Ä—ã—Ç –ª–∏ gallery sheet**. –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≥–∞–ª–µ—Ä–µ–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `hasScanned` –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å `true`, –ø–æ—ç—Ç–æ–º—É –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–ª–∞—Å—å.

---

### –ë–∞–≥ #2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ ‚ùå

**–û–ø–∏—Å–∞–Ω–∏–µ:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
4. **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:**

```javascript
// imageDetection.ts
if (window.__obrazzDetectionInitialized) {
  console.log('[ImageDetection] Already initialized, skipping');
  return; // –°–∫—Ä–∏–ø—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
}
```

–°–∫—Ä–∏–ø—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–ª–∞–≥ `window.__obrazzDetectionInitialized` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –û–¥–Ω–∞–∫–æ:

1. –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ WebView (–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–∞–º) —Ñ–ª–∞–≥ **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ —Ç–æ–º –∂–µ window context
2. –°–∫—Ä–∏–ø—Ç `injectedJavaScript` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ WebView
3. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∫—Ä–∏–ø—Ç **–Ω–µ –ø–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. Event listener `detectImages` –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ #1: –£—Å–ª–æ–≤–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏

#### DetectionFAB.tsx

**–ë—ã–ª–æ:**

```typescript
// Hide button if items detected
if (hasScanned && detectedImages.length > 0 && !isScanning) {
  return null;
}
```

**–°—Ç–∞–ª–æ:**

```typescript
// Hide button ONLY when gallery sheet is open
if (showGallerySheet && detectedImages.length > 0) {
  return null;
}
```

**–õ–æ–≥–∏–∫–∞:**

- –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ gallery sheet –æ—Ç–∫—Ä—ã—Ç**
- –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è gallery –∫–Ω–æ–ø–∫–∞ —Å–Ω–æ–≤–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `hasScanned` –±–æ–ª—å—à–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç—å

#### GalleryBottomSheet.tsx

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ handleClose:**

```typescript
const handleClose = useCallback(() => {
  bottomSheetRef.current?.close();
  showGallery(false);
  clearSelection();
  // Reset hasScanned so scan button can appear again
  setHasScanned(false);
}, [showGallery, clearSelection, setHasScanned]);
```

**–õ–æ–≥–∏–∫–∞:**

- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≥–∞–ª–µ—Ä–µ–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ `hasScanned`
- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ #2: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞

#### browser.tsx

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ handleLoadEnd:**

```typescript
// Reset detection script initialization flag and re-inject script on new page
if (webViewRef.current) {
  console.log('[Browser] Re-initializing detection script for new page');

  // First, reset the initialization flag
  webViewRef.current.injectJavaScript(`
    (function() {
      if (window.__obrazzDetectionInitialized) {
        console.log('[Browser] Resetting detection initialization flag');
        delete window.__obrazzDetectionInitialized;
      }
    })();
    true;
  `);

  // Then, re-inject the detection script with a small delay
  setTimeout(() => {
    if (webViewRef.current) {
      webViewRef.current.injectJavaScript(imageDetectionScript);
    }
  }, 100);
}
```

**–õ–æ–≥–∏–∫–∞:**

1. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–¥–∞–ª—è–µ—Ç—Å—è —Ñ–ª–∞–≥ `window.__obrazzDetectionInitialized`
2. –°–∫—Ä–∏–ø—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 100ms
3. Event listener `detectImages` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
4. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Flow

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–∞–∂–∏–º–∞–µ—Ç "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
   ‚Üí isScanning = true
   ‚Üí –ö–Ω–æ–ø–∫–∞: "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..."

2. –°–∫—Ä–∏–ø—Ç: –Ω–∞—Ö–æ–¥–∏—Ç –≤–µ—â–∏
   ‚Üí isScanning = false
   ‚Üí hasScanned = true
   ‚Üí detectedImages = [...]
   ‚Üí showGallerySheet = true

3. UI: –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è (showGallerySheet === true)
   ‚Üí Gallery sheet –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –∑–∞–∫—Ä—ã–≤–∞–µ—Ç gallery
   ‚Üí showGallerySheet = false
   ‚Üí hasScanned = false (–°–ë–†–û–°!)

5. UI: –ö–Ω–æ–ø–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–Ω–æ–≤–∞
   ‚Üí –¢–µ–∫—Å—Ç: "üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
   ‚Üí handleNavigationStateChange —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   ‚Üí resetScanState() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   ‚Üí isScanning = false
   ‚Üí hasScanned = false
   ‚Üí detectedImages = []

2. WebView: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
   ‚Üí handleLoadEnd —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   ‚Üí delete window.__obrazzDetectionInitialized
   ‚Üí imageDetectionScript –ø–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è

3. UI: –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"

4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–∞–∂–∏–º–∞–µ—Ç "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
   ‚Üí Event 'detectImages' —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚úÖ
   ‚Üí –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

---

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∫–Ω–æ–ø–∫–∏

| isScanning | hasScanned | detectedImages | showGallerySheet | –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏                       |
| ---------- | ---------- | -------------- | ---------------- | -------------------------------------- |
| false      | false      | []             | false            | "üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" (—á—ë—Ä–Ω–∞—è)              |
| true       | false      | []             | false            | "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..." (—Å–µ—Ä–∞—è + loader)     |
| false      | true       | []             | false            | "‚úÇÔ∏è –í—ã—Ä–µ–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é" (–∑–µ–ª—ë–Ω–∞—è)        |
| false      | true       | [items]        | false            | "üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" (—á—ë—Ä–Ω–∞—è) ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û |
| false      | true       | [items]        | true             | **–°–∫—Ä—ã—Ç–∞**                             |

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### ‚úÖ –¢–µ—Å—Ç 1: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≥–∞–ª–µ—Ä–µ–∏

**–®–∞–≥–∏:**

1. –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω ZARA
2. –ù–∞–∂–∞—Ç—å "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
3. –î–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç–∏—è gallery sheet
4. –ó–∞–∫—Ä—ã—Ç—å gallery (—Å–≤–∞–π–ø –≤–Ω–∏–∑ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ ‚úï)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" —Å–Ω–æ–≤–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
- ‚úÖ –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ

**–ë—ã–ª–æ:** ‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–ª–∞—Å—å

---

### ‚úÖ –¢–µ—Å—Ç 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

**–®–∞–≥–∏:**

1. –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω ZARA
2. –ù–∞–∂–∞—Ç—å "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" ‚Üí –Ω–∞–π–¥–µ–Ω—ã –≤–µ—â–∏
3. –ó–∞–∫—Ä—ã—Ç—å gallery
4. –ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
5. –ù–∞–∂–∞—Ç—å "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- ‚úÖ –ù–∞—Ö–æ–¥—è—Ç—Å—è –Ω–æ–≤—ã–µ –≤–µ—â–∏

**–ë—ã–ª–æ:** ‚ùå –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞

---

### ‚úÖ –¢–µ—Å—Ç 3: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

**–®–∞–≥–∏:**

1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ó–∞–∫—Ä—ã—Ç—å gallery
2. –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ó–∞–∫—Ä—ã—Ç—å gallery
3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3: –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ó–∞–∫—Ä—ã—Ç—å gallery

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è gallery

**–ë—ã–ª–æ:** ‚ùå –†–∞–±–æ—Ç–∞–ª–æ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

---

### ‚úÖ –¢–µ—Å—Ç 4: –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –ù–∞–π–¥–µ–Ω–æ ‚Üí –°–Ω–æ–≤–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

**–®–∞–≥–∏:**

1. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–µ–∑ –æ–¥–µ–∂–¥—ã (–±–ª–æ–≥)
2. –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–í—ã—Ä–µ–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é"
3. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ç–∞–ª–æ–≥–∞
4. –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ù–∞–π–¥–µ–Ω—ã –≤–µ—â–∏ ‚Üí –ó–∞–∫—Ä—ã—Ç—å gallery
5. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–ª–æ–≥–∞
6. –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚úÖ "–í—ã—Ä–µ–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é" –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

---

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. components/shopping/DetectionFAB.tsx

- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ —Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `showGallerySheet`

### 2. components/shopping/GalleryBottomSheet.tsx

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `setHasScanned` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ –°–±—Ä–æ—Å `hasScanned` –≤ `handleClose`

### 3. app/shopping/browser.tsx

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ `handleLoadEnd`
- ‚úÖ –ü–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

- ‚ùå –ö–Ω–æ–ø–∫–∞ –∏—Å—á–µ–∑–∞–ª–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

- ‚úÖ –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è gallery
- ‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑
- ‚úÖ –ú–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ WebView
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –∫–Ω–æ–ø–∫–∏

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏:

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É):**

1. `isScanning === true` ‚Üí "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..." (—Å–µ—Ä–∞—è, disabled)
2. `showGallerySheet === true` ‚Üí –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞
3. `hasScanned && detectedImages.length === 0` ‚Üí "–í—ã—Ä–µ–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é" (–∑–µ–ª—ë–Ω–∞—è)
4. **Default** ‚Üí "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" (—á—ë—Ä–Ω–∞—è)

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏:

```
WebView –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
  ‚Üì
injectedJavaScript –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
  ‚Üì
window.__obrazzDetectionInitialized = true
  ‚Üì
Event listener 'detectImages' —Å–æ–∑–¥–∞–Ω
  ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É]
  ‚Üì
handleLoadEnd —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
  ‚Üì
delete window.__obrazzDetectionInitialized
  ‚Üì
imageDetectionScript –ø–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è
  ‚Üì
window.__obrazzDetectionInitialized = true (–∑–∞–Ω–æ–≤–æ)
  ‚Üì
Event listener 'detectImages' —Å–æ–∑–¥–∞–Ω (–∑–∞–Ω–æ–≤–æ)
```

---

## üìö –£—Ä–æ–∫–∏

1. **State synchronization:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ UI —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
2. **WebView lifecycle:** –°–∫—Ä–∏–ø—Ç—ã, –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `injectedJavaScript`, –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
3. **Navigation in WebView:** –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ WebView context —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–æ DOM –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
4. **Reset patterns:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–Ω–∞–≤–∏–≥–∞—Ü–∏–∏

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –±–∞–≥–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ —Ä—É—á–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

- –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≥–∞–ª–µ—Ä–µ–∏
- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
- –°–æ—Å—Ç–æ—è–Ω–∏—è —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ

**–ì–æ—Ç–æ–≤–æ –∫ production! üöÄ**
