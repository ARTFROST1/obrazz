# Image Detection System Fix - December 15, 2025

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ö–Ω–æ–ø–∫–∞ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –∑–∞–≤–∏—Å–∞–ª–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..." –∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–∞—Ö.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Event-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±—ã–ª–∞ –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ–π**
   - –°–∫—Ä–∏–ø—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª event listener –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   - –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ listener –º–æ–≥ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω
   - –°–æ–±—ã—Ç–∏—è –º–æ–≥–ª–∏ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç—å –¥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

2. **IIFE –∏–∑–æ–ª—è—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π**
   - `detectImages()` –±—ã–ª–∞ –≤–Ω—É—Ç—Ä–∏ IIFE –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–∑–≤–∞—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å WebView lifecycle**
   - –°–∫—Ä–∏–ø—Ç –∏–Ω–∂–µ–∫—Ç–∏–ª—Å—è —á–µ—Ä–µ–∑ `injectedJavaScript` –æ–¥–∏–Ω —Ä–∞–∑
   - –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–≥–ª–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏

4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤**
   - –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è - UI –∑–∞–≤–∏—Å–∞–ª
   - –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ ReactNativeWebView –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ü–µ—Ä–µ–ø–∏—Å–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ ([utils/shopping/imageDetection.ts](../utils/shopping/imageDetection.ts))

**–ë—ã–ª–æ:**

```javascript
// Event-based approach
document.addEventListener('detectImages', function () {
  detectImages(); // Function inside IIFE
});
```

**–°—Ç–∞–ª–æ:**

```javascript
// Direct callable function
window.__obrazzDetectImages = function () {
  // Detection logic here...
  // Send results via postMessage
};
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- ‚úÖ –£–±—Ä–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ –∫–∞–∫ `window.__obrazzDetectImages`
- ‚úÖ –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- ‚úÖ –°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è - —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –≤–Ω—É—Ç—Ä–∏

### 2. –û–±–Ω–æ–≤–ª–µ–Ω handleScan ([app/shopping/browser.tsx](../app/shopping/browser.tsx))

**–ë—ã–ª–æ:**

```javascript
// Dispatch event to trigger detection
const event = new Event('detectImages');
document.dispatchEvent(event);
```

**–°—Ç–∞–ª–æ:**

```javascript
// Re-inject script + call directly
webViewRef.current.injectJavaScript(`
  ${imageDetectionScript}
  
  // Call immediately
  window.__obrazzDetectImages();
`);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∂–µ–∫—Ü–∏—è** —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ (–≥–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞–ª–∏—á–∏—è)
- ‚úÖ **–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤** —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫
- ‚úÖ **Safety timeout** - —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥

### 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**

- Safety timeout –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞ `isScanning` —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
- Fallback: –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –Ø–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `typeof window.__obrazzDetectImages === 'function'`
- Error catching –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ React Native

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–£–ª—É—á—à–µ–Ω–∏—è –≤ —Å–∫—Ä–∏–ø—Ç–µ:**

- –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `window.__obrazzDetectionInitialized` (–Ω–µ –Ω—É–∂–Ω–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∂–µ–∫—Ü–∏–∏)
- –£–¥–∞–ª–µ–Ω event listener (–ª–∏—à–Ω–∏–π —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)
- –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ ‚Üí –º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–µ–∫
- –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –ª–æ–≥–∏

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å":

```
1. setScanning(true) ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..."
         ‚Üì
2. –ó–∞–ø—É—Å–∫–∞–µ–º safety timeout (7 —Å–µ–∫)
         ‚Üì
3. –ñ–¥–µ–º 500ms (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å UI)
         ‚Üì
4. –ü–æ–≤—Ç–æ—Ä–Ω–æ –∏–Ω–∂–µ–∫—Ç–∏–º imageDetectionScript –≤ WebView
         ‚Üì
5. –°—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º window.__obrazzDetectImages()
         ‚Üì
6. –°–∫—Ä–∏–ø—Ç —Å–∫–∞–Ω–∏—Ä—É–µ—Ç DOM, –Ω–∞—Ö–æ–¥–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–¥–µ–∂–¥—ã
         ‚Üì
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ postMessage
         ‚Üì
8. handleMessage –ø–æ–ª—É—á–∞–µ—Ç ‚Üí —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç scanning ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Gallery
```

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

- **–ò–Ω–∂–µ–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞:** ~50-100ms
- **–î–µ—Ç–µ–∫—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:** ~100-500ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
- **–û–±—â–µ–µ –≤—Ä–µ–º—è:** 0.5-1.5 —Å–µ–∫—É–Ω–¥—ã

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∏–Ω–∂–µ–∫—Ü–∏—è –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç lifecycle WebView
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π**
   - –û—Ç–∫—Ä—ã—Ç—å Shopping Browser
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ ZARA/H&M
   - –ù–∞–∂–∞—Ç—å "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ù–∞—à–ª–∏—Å—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –æ—Ç–∫—Ä—ã–ª–∞—Å—å Gallery

2. **–ù–∞–≤–∏–≥–∞—Ü–∏—è**
   - –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
   - –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥—É—é
   - –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ–±–µ–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

3. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤**
   - –û—Ç–∫—Ä—ã—Ç—å 2 –º–∞–≥–∞–∑–∏–Ω–∞
   - –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–≤–æ–º
   - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≤—Ç–æ—Ä–æ–π
   - –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–æ –≤—Ç–æ—Ä–æ–º
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–æ–∏—Ö —Ç–∞–±–∞—Ö

4. **–ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**
   - –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–¥–µ–∂–¥—ã
   - –ù–∞–∂–∞—Ç—å "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å"
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è:** "–í—ã—Ä–µ–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é" —á–µ—Ä–µ–∑ 1-2 —Å–µ–∫—É–Ω–¥—ã

5. **–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**
   - –û—Ç–∫—Ä—ã—Ç—å —Ç—è–∂–µ–ª—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
   - –ù–∞–∂–∞—Ç—å "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –¥–æ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ù–∞–π–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```
WebView Load ‚Üí injectedJavaScript ‚Üí Register Event Listener
                                              ‚Üì
Button Click ‚Üí injectJavaScript ‚Üí Dispatch Event ‚Üí Listener ‚Üí Detect
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Event listener –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```
Button Click ‚Üí injectJavaScript ‚Üí Load Function + Call It ‚Üí Detect
```

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:

1. **utils/shopping/imageDetection.ts**
   - –£–±—Ä–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π
   - –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `window.__obrazzDetectImages`
   - –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞

2. **app/shopping/browser.tsx**
   - `handleScan()` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∂–µ–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üìà Performance Impact

**–ë—ã–ª–æ:**

- –ò–Ω–∂–µ–∫—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: 1 —Ä–∞–∑
- –î–µ—Ç–µ–∫—Ü–∏—è: event ‚Üí listener ‚Üí function

**–°—Ç–∞–ª–æ:**

- –ò–Ω–∂–µ–∫—Ü–∏—è –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: –∫–∞–∂–¥—ã–π —Ä–∞–∑ (~100ms)
- –î–µ—Ç–µ–∫—Ü–∏—è: –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏

**Trade-off:** –ù–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∏–Ω–∂–µ–∫—Ü–∏—é, –Ω–æ **100% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å**

## ‚úÖ Checklist

- [x] –ü–µ—Ä–µ–ø–∏—Å–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏
- [x] –û–±–Ω–æ–≤–ª–µ–Ω handleScan
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [x] Safety timeout –¥–ª—è UI
- [x] TypeScript —Ç–∏–ø—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Manual testing –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö (ZARA, H&M, Asos)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ iOS/Android

---

**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–î–∞—Ç–∞:** 15 –¥–µ–∫–∞–±—Ä—è 2025
