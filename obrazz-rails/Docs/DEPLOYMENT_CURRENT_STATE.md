# Obrazz Rails — Current Deployment State (Render)

_Last updated: 2026-01-28_

## Status (production)

- Service URL: https://obrazz.onrender.com
- Root (`/`) redirects to `/login`
- Login page: `GET /login` returns **200**
- Health check: `GET /api/v1/health` returns **200** (JSON)

Quick verification commands:

```bash
curl -I https://obrazz.onrender.com/
curl -I https://obrazz.onrender.com/login
curl -I https://obrazz.onrender.com/api/v1/health
```

## Render configuration (source of truth)

Render Dashboard currently has:

- **rootDir:** `obrazz-rails`
- **buildCommand:** `./bin/render-build`
- **startCommand:** `bundle exec puma`
- Region: Frankfurt
- Plan: free

Notes:

- `render.yaml` exists, but for an already-created service Render does **not** reliably sync all settings from the blueprint. Treat the Dashboard settings above as authoritative.

## Build pipeline

Build is executed by [bin/render-build](../bin/render-build):

1. `bundle install`
2. `rails assets:precompile`
3. `rails db:migrate`
4. `rails db:migrate:cache`
5. `rails db:migrate:queue`
6. `rails db:migrate:cable`

This ordering matters because Solid Cache/Queue/Cable tables must exist before the app can safely use those subsystems.

## Databases: multi-DB wiring for Solid stack

Multi-database config is in [config/database.yml](../config/database.yml).

We use one Supabase Postgres URL (transaction-pooler) for:

- `primary`
- `cache` (Solid Cache)
- `queue` (Solid Queue)
- `cable` (Solid Cable)

Key requirement for Supabase pooler:

- `prepared_statements: false` in production.

Migration paths:

- `db/migrate` (primary)
- `db/cache_migrate`
- `db/queue_migrate`
- `db/cable_migrate`

Cache store config is in [config/cache.yml](../config/cache.yml) and points to the `cache` database.

## Solid Queue execution mode (in-process)

Puma is configured to run Solid Queue inside the web process when enabled:

- [config/puma.rb](../config/puma.rb): `plugin :solid_queue if ENV["SOLID_QUEUE_IN_PUMA"]`

On Render, set:

- `SOLID_QUEUE_IN_PUMA=true`

This avoids needing a separate worker service on free tier.

## Rack::Attack (rate limiting)

Initializer: [config/initializers/rack_attack.rb](../config/initializers/rack_attack.rb)

Important behavior:

- Uses `ActiveSupport::Cache::MemoryStore` (NOT Solid Cache).
  - Reason: Rack::Attack initializes very early; DB-backed cache can break boot if DB isn’t ready.

Rate limiting highlights:

- Global per-IP throttle (`/assets` and `/health` excluded)
- Stricter throttles for:
  - `/api/v1/ai/*`
  - `/api/v1/auth/*`
  - `/api/v1/webhooks/*`

## Assets / Sprockets / Tailwind / Importmap

We are using `sprockets-rails` + `importmap-rails`.

Sprockets manifest is [app/assets/config/manifest.js](../app/assets/config/manifest.js) and MUST include:

- `//= link tailwind.css` (otherwise `/login` 500 with `Asset tailwind.css was not declared to be precompiled`)
- `//= link_tree ../../javascript .js` (otherwise `/login` 500 with `Asset application.js was not declared to be precompiled` via `javascript_importmap_tags`)

Directory gotchas:

- Sprockets `link_tree` requires the directory to exist in the build context.
- To keep empty directories in git, we use `.keep` files (e.g. `app/assets/images/.keep`).

## API + UI routes (high level)

Routing is defined in [config/routes.rb](../config/routes.rb):

- API namespace: `/api/v1/*`
- Public health endpoint: `/api/v1/health`
- UI auth routes: `/login`, `/logout`, `/auth/callback`
- Root: redirects to `/login`

## Required environment variables (production)

Render must provide at minimum:

- `DATABASE_URL` (Supabase Postgres connection string)
- `RAILS_ENV=production`
- `RAILS_LOG_TO_STDOUT=true`
- `RAILS_SERVE_STATIC_FILES=true`
- `SECRET_KEY_BASE` (generated by Render)
- `RAILS_MASTER_KEY` (for credentials)

Supabase Auth:

- `SUPABASE_URL`
- `SUPABASE_JWT_SECRET`
- `SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

## Troubleshooting checklist

If deploy/build breaks:

1. Check latest Render build logs for:
   - `Sprockets::ArgumentError: link_tree argument must be a directory`
   - `Asset ... was not declared to be precompiled`
2. Verify Dashboard build/start commands are still:
   - build: `./bin/render-build`
   - start: `bundle exec puma`
3. Verify migrations ran:
   - `db:migrate:cache`, `db:migrate:queue`, `db:migrate:cable`
4. Verify runtime endpoints:
   - `/api/v1/health` returns 200
   - `/login` returns 200
