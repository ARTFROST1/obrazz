<% content_for :title, "Dashboard" %>

<% content_for :header do %>
  <h1 class="text-3xl font-bold tracking-tight text-gray-900">Dashboard</h1>
<% end %>

<div class="px-4 sm:px-0">
  <!-- Stats Grid -->
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
    <!-- Total Users -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="rounded-md bg-brand-500 p-3">
              <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Total Users</dt>
              <dd class="flex items-baseline">
                <div class="text-2xl font-semibold text-gray-900"><%= number_with_delimiter(@stats[:total_users]) %></div>
                <div class="ml-2 text-sm text-green-600">
                  +<%= @stats[:users_this_week] %> this week
                </div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Subscriptions -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="rounded-md bg-green-500 p-3">
              <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Active Subscriptions</dt>
              <dd class="text-2xl font-semibold text-gray-900"><%= number_with_delimiter(@stats[:active_subscriptions]) %></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Revenue -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="rounded-md bg-yellow-500 p-3">
              <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Total Revenue</dt>
              <dd class="flex items-baseline">
                <div class="text-2xl font-semibold text-gray-900"><%= number_to_currency(@stats[:total_revenue], unit: '₽', precision: 0, format: '%n %u') %></div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <!-- Generations Today -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="rounded-md bg-pink-500 p-3">
              <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">AI Generations</dt>
              <dd class="flex items-baseline">
                <div class="text-2xl font-semibold text-gray-900"><%= number_with_delimiter(@stats[:total_generations]) %></div>
                <div class="ml-2 text-sm text-gray-500">
                  (<%= @stats[:generations_today] %> today)
                </div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="mt-8 grid grid-cols-1 gap-5 lg:grid-cols-2">
    <!-- Revenue Chart -->
    <div class="bg-white shadow rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Revenue (7 days)</h3>
      <div class="relative h-64">
        <canvas id="revenueChart" class="w-full h-full"></canvas>
      </div>
    </div>

    <!-- Generations Chart -->
    <div class="bg-white shadow rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">AI Generations (7 days)</h3>
      <div class="relative h-64">
        <canvas id="generationsChart" class="w-full h-full"></canvas>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="mt-8 grid grid-cols-1 gap-5 lg:grid-cols-3">
    <!-- Recent Users -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Recent Users</h3>
      </div>
      <ul role="list" class="divide-y divide-gray-200">
        <% @recent_users.each do |user| %>
          <li class="px-4 py-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="h-10 w-10 rounded-full bg-brand-100 flex items-center justify-center">
                  <span class="text-brand-700 font-medium"><%= user.email[0].upcase %></span>
                </div>
              </div>
              <div class="ml-3 min-w-0 flex-1">
                <p class="text-sm font-medium text-gray-900 truncate"><%= user.full_name.presence || user.username.presence || user.email %></p>
                <p class="text-xs text-gray-500"><%= time_ago_in_words(user.created_at) %> ago</p>
              </div>
              <a href="<%= admin_user_path(user) %>" class="text-brand-600 hover:text-brand-900 text-sm">View</a>
            </div>
          </li>
        <% end %>
      </ul>
      <div class="px-4 py-3 bg-gray-50 rounded-b-lg">
        <a href="<%= admin_users_path %>" class="text-sm font-medium text-brand-600 hover:text-brand-500">View all users →</a>
      </div>
    </div>

    <!-- Recent Payments -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Recent Payments</h3>
      </div>
      <ul role="list" class="divide-y divide-gray-200">
        <% @recent_payments.each do |payment| %>
          <li class="px-4 py-4">
            <div class="flex items-center justify-between">
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-gray-900 truncate"><%= payment.user&.email %></p>
                <p class="text-xs text-gray-500"><%= payment.payment_type %> · <%= time_ago_in_words(payment.created_at) %> ago</p>
              </div>
              <div class="text-right">
                <p class="text-sm font-semibold text-green-600">+<%= number_to_currency(payment.amount, unit: '₽', precision: 0, format: '%n%u') %></p>
              </div>
            </div>
          </li>
        <% end %>
        <% if @recent_payments.empty? %>
          <li class="px-4 py-8 text-center text-gray-500 text-sm">No payments yet</li>
        <% end %>
      </ul>
      <div class="px-4 py-3 bg-gray-50 rounded-b-lg">
        <a href="<%= admin_payments_path %>" class="text-sm font-medium text-brand-600 hover:text-brand-500">View all payments →</a>
      </div>
    </div>

    <!-- Recent Generations -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Recent Generations</h3>
      </div>
      <ul role="list" class="divide-y divide-gray-200">
        <% @recent_generations.each do |gen| %>
          <li class="px-4 py-4">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 rounded bg-gray-100 overflow-hidden">
                <% if gen.primary_output_url.present? %>
                  <img src="<%= gen.primary_output_url %>" alt="" class="h-full w-full object-cover">
                <% else %>
                  <div class="h-full w-full flex items-center justify-center text-gray-400">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                <% end %>
              </div>
              <div class="ml-3 min-w-0 flex-1">
                <p class="text-sm font-medium text-gray-900"><%= gen.generation_type.titleize %></p>
                <p class="text-xs text-gray-500"><%= gen.user&.email&.truncate(20) %></p>
              </div>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= gen.status == 'completed' ? 'bg-green-100 text-green-800' : gen.status == 'failed' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' %>">
                <%= gen.status %>
              </span>
            </div>
          </li>
        <% end %>
        <% if @recent_generations.empty? %>
          <li class="px-4 py-8 text-center text-gray-500 text-sm">No generations yet</li>
        <% end %>
      </ul>
      <div class="px-4 py-3 bg-gray-50 rounded-b-lg">
        <a href="<%= admin_ai_generations_path %>" class="text-sm font-medium text-brand-600 hover:text-brand-500">View all generations →</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chartData = <%= raw @chart_data.to_json %>;
    
    // Revenue Chart
    new Chart(document.getElementById('revenueChart'), {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Revenue (₽)',
          data: chartData.revenue,
          backgroundColor: 'rgba(168, 85, 247, 0.5)',
          borderColor: 'rgb(168, 85, 247)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
    
    // Generations Chart
    new Chart(document.getElementById('generationsChart'), {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Generations',
          data: chartData.generations,
          borderColor: 'rgb(236, 72, 153)',
          backgroundColor: 'rgba(236, 72, 153, 0.1)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  });
</script>
