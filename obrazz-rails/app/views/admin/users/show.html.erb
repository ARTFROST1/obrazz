<% content_for :title, (@user.full_name.presence || @user.username.presence || @user.email) %>

<% content_for :header do %>
  <div class="sm:flex sm:items-center sm:justify-between">
    <div class="flex items-center">
      <a href="<%= admin_users_path %>" class="mr-4 text-gray-400 hover:text-gray-600">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
      </a>
      <div>
        <h1 class="text-3xl font-bold tracking-tight text-gray-900"><%= @user.full_name.presence || @user.username.presence || @user.email %></h1>
        <p class="text-sm text-gray-500"><%= @user.email %></p>
      </div>
    </div>
  </div>
<% end %>

<div class="px-4 sm:px-0">
  <!-- User Info Card -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex items-center justify-between">
      <div class="flex items-center">
        <% if @user.avatar_url.present? %>
          <img class="h-16 w-16 rounded-full" src="<%= @user.avatar_url %>" alt="">
        <% else %>
          <div class="h-16 w-16 rounded-full bg-brand-100 flex items-center justify-center">
            <span class="text-2xl text-brand-700 font-medium"><%= @user.email[0].upcase %></span>
          </div>
        <% end %>
        <div class="ml-4">
          <h3 class="text-lg font-medium text-gray-900"><%= @user.full_name.presence || @user.username.presence || 'No name' %></h3>
          <p class="text-sm text-gray-500">Member since <%= @user.created_at.strftime('%B %d, %Y') %></p>
        </div>
      </div>
      <div class="flex space-x-2">
        <% if @user.subscription.present? %>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= @user.subscription.status == 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
            <%= @user.subscription.plan.titleize %> · <%= @user.subscription.status %>
          </span>
        <% else %>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
            Free Tier
          </span>
        <% end %>
      </div>
    </div>
    <div class="border-t border-gray-200">
      <dl>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Email</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @user.email %></dd>
        </div>
        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Supabase ID</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 font-mono text-xs"><%= @user.supabase_id %></dd>
        </div>
        <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Token Balance</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <span class="font-semibold text-lg"><%= @user.available_tokens %></span> tokens
          </dd>
        </div>
        <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Last Active</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= @user.last_active_at ? time_ago_in_words(@user.last_active_at) + ' ago' : 'Never' %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-4">
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Total Generations</dt>
              <dd class="text-lg font-semibold text-gray-900"><%= @stats[:total_generations] %></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Total Spent</dt>
              <dd class="text-lg font-semibold text-gray-900"><%= number_to_currency(@stats[:total_spent], unit: '₽', precision: 0, format: '%n%u') %></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Tokens Used</dt>
              <dd class="text-lg font-semibold text-gray-900"><%= @stats[:tokens_used] %></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Member Since</dt>
              <dd class="text-lg font-semibold text-gray-900"><%= @stats[:member_since].strftime('%b %Y') %></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mt-8">
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button class="border-brand-500 text-brand-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="generations">
          Generations
        </button>
        <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="payments">
          Payments
        </button>
        <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="transactions">
          Token Transactions
        </button>
      </nav>
    </div>

    <!-- Generations Tab -->
    <div id="generations-tab" class="mt-4">
      <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <% if @recent_generations.any? %>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 p-4">
            <% @recent_generations.each do |gen| %>
              <a href="<%= admin_ai_generation_path(gen) %>" class="group relative">
                <div class="aspect-square rounded-lg overflow-hidden bg-gray-100">
                  <% if gen.primary_output_url.present? %>
                    <img src="<%= gen.primary_output_url %>" alt="" class="h-full w-full object-cover group-hover:opacity-75 transition-opacity">
                  <% else %>
                    <div class="h-full w-full flex items-center justify-center text-gray-400">
                      <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                  <% end %>
                </div>
                <p class="mt-1 text-xs text-gray-500 truncate"><%= gen.generation_type %></p>
              </a>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-12">
            <p class="text-sm text-gray-500">No generations yet</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="payments-tab" class="mt-4 hidden">
      <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <% if @recent_payments.any? %>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Provider</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @recent_payments.each do |payment| %>
                <tr>
                  <td class="px-6 py-4 text-sm text-gray-500"><%= payment.created_at.strftime('%b %d, %Y') %></td>
                  <td class="px-6 py-4 text-sm text-gray-900"><%= payment.payment_type %></td>
                  <td class="px-6 py-4 text-sm text-gray-500"><%= payment.provider %></td>
                  <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= payment.status == 'succeeded' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                      <%= payment.status %>
                    </span>
                  </td>
                  <td class="px-6 py-4 text-sm text-right font-medium"><%= number_to_currency(payment.amount, unit: '₽', precision: 0, format: '%n%u') %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="text-center py-12">
            <p class="text-sm text-gray-500">No payments yet</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div id="transactions-tab" class="mt-4 hidden">
      <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <% if @recent_transactions.any? %>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @recent_transactions.each do |tx| %>
                <tr>
                  <td class="px-6 py-4 text-sm text-gray-500"><%= tx.created_at.strftime('%b %d, %H:%M') %></td>
                  <td class="px-6 py-4 text-sm text-gray-900"><%= (tx.reason.presence || tx.operation).to_s.titleize %></td>
                  <td class="px-6 py-4 text-sm text-gray-500"><%= tx.description %></td>
                  <td class="px-6 py-4 text-sm text-right font-medium <%= tx.amount > 0 ? 'text-green-600' : 'text-red-600' %>">
                    <%= tx.amount > 0 ? '+' : '' %><%= tx.amount %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="text-center py-12">
            <p class="text-sm text-gray-500">No token transactions yet</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('[data-tab]').forEach(btn => {
    btn.addEventListener('click', function() {
      // Update buttons
      document.querySelectorAll('[data-tab]').forEach(b => {
        b.classList.remove('border-brand-500', 'text-brand-600');
        b.classList.add('border-transparent', 'text-gray-500');
      });
      this.classList.add('border-brand-500', 'text-brand-600');
      this.classList.remove('border-transparent', 'text-gray-500');
      
      // Update panels
      document.querySelectorAll('[id$="-tab"]').forEach(p => p.classList.add('hidden'));
      document.getElementById(this.dataset.tab + '-tab').classList.remove('hidden');
    });
  });
</script>
