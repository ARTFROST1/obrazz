<% content_for(:title) { 'Авторизация - Obrazz' } %>

<div class="text-center space-y-6">
  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#1A1A2E] mx-auto"></div>
  <h1 class="text-xl font-semibold text-[#1A1A2E]">Авторизация...</h1>
  <p class="text-sm text-[#666666]">Пожалуйста, подождите</p>
</div>

<script>
  // Обработка OAuth callback от Supabase
  (function() {
    const hash = window.location.hash;
    const params = new URLSearchParams(window.location.search);
    
    // Проверяем наличие ошибки в query params
    if (params.get('error')) {
      const errorMessage = params.get('error_description') || params.get('error');
      window.location.href = '<%= login_path %>?error=' + encodeURIComponent(errorMessage);
      return;
    }

    // Извлекаем токены из hash fragment
    // Supabase использует implicit flow: #access_token=...&refresh_token=...&...
    if (hash && hash.includes('access_token=')) {
      const hashParams = new URLSearchParams(hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');
      const tokenType = hashParams.get('token_type');
      const expiresIn = hashParams.get('expires_in');
      
      if (accessToken) {
        // Отправляем токены на сервер
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        
        fetch('<%= auth_token_path %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken,
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken,
            token_type: tokenType,
            expires_in: expiresIn
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.redirect_to) {
            // Очищаем hash из URL и редиректим
            window.location.href = data.redirect_to;
          } else {
            window.location.href = '<%= login_path %>?error=' + encodeURIComponent(data.error || 'Authentication failed');
          }
        })
        .catch(error => {
          console.error('OAuth callback error:', error);
          window.location.href = '<%= login_path %>?error=' + encodeURIComponent('Authentication failed');
        });
        
        return;
      }
    }
    
    // Если нет токена и нет ошибки - что-то пошло не так
    // Даём время на загрузку, затем редиректим
    setTimeout(function() {
      if (!window.location.hash.includes('access_token=')) {
        window.location.href = '<%= login_path %>?error=' + encodeURIComponent('No authentication data received');
      }
    }, 3000);
  })();
</script>
