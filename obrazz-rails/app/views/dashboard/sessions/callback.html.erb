<% content_for(:title) { 'Аутентификация - Obrazz' } %>

<div class="text-center space-y-6">
  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
  <h1 class="text-xl font-semibold text-gray-900">Авторизация...</h1>
  <p class="text-sm text-gray-500">Пожалуйста, подождите</p>
</div>

<script>
  // Обработка callback от Supabase
  (function() {
    const hash = window.location.hash;
    const params = new URLSearchParams(window.location.search);
    
    // Проверяем hash fragment (Supabase использует implicit flow)
    if (hash && hash.includes('access_token=')) {
      const hashParams = new URLSearchParams(hash.substring(1));
      const accessToken = hashParams.get('access_token');
      
      if (accessToken) {
        // Отправляем токен на сервер
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '<%= login_path %>';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'authenticity_token';
        csrfInput.value = document.querySelector('meta[name="csrf-token"]').content;
        form.appendChild(csrfInput);
        
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = 'token';
        tokenInput.value = accessToken;
        form.appendChild(tokenInput);
        
        document.body.appendChild(form);
        form.submit();
        return;
      }
    }
    
    // Если нет токена - ошибка
    if (params.get('error')) {
      window.location.href = '<%= login_path %>?error=' + encodeURIComponent(params.get('error_description') || 'Authentication failed');
    } else {
      // Нет данных - перенаправляем на логин
      setTimeout(function() {
        window.location.href = '<%= login_path %>';
      }, 2000);
    }
  })();
</script>
