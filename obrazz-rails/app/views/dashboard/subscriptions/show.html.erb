<% content_for(:title) { 'Подписка - Obrazz' } %>

<!-- Page Header -->
<div class="mb-8">
  <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
    Подписка
  </h1>
  <p class="mt-1 text-sm text-gray-500">
    Управляйте вашей подпиской и платежами
  </p>
</div>

<!-- Current Subscription Card -->
<div class="bg-white shadow rounded-xl overflow-hidden mb-8">
  <div class="p-6 sm:p-8">
    <div class="sm:flex sm:items-start sm:justify-between">
      <div>
        <div class="flex items-center">
          <% if @subscription.pro? %>
            <span class="inline-flex items-center rounded-full bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-1.5 text-sm font-semibold text-white">
              <svg class="mr-1.5 h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" />
              </svg>
              Pro
            </span>
          <% else %>
            <span class="inline-flex items-center rounded-full bg-gray-100 px-4 py-1.5 text-sm font-semibold text-gray-600">
              Free
            </span>
          <% end %>
          
          <% if @subscription.status == 'cancelled' %>
            <span class="ml-3 inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
              Отменена
            </span>
          <% end %>
        </div>
        
        <h2 class="mt-4 text-xl font-bold text-gray-900">
          <% if @subscription.pro? %>
            <%= @subscription.plan == 'pro_monthly' ? 'Pro Monthly' : 'Pro Yearly' %>
          <% else %>
            Бесплатный план
          <% end %>
        </h2>
        
        <% if @subscription.pro? && @subscription.current_period_end.present? %>
          <p class="mt-1 text-sm text-gray-500">
            <% if @subscription.status == 'cancelled' %>
              Действует до: <%= @subscription.current_period_end.strftime('%d.%m.%Y') %>
            <% else %>
              Следующее списание: <%= @subscription.current_period_end.strftime('%d.%m.%Y') %>
            <% end %>
          </p>
        <% end %>
      </div>
      
      <div class="mt-5 sm:mt-0 sm:ml-6 sm:flex sm:flex-shrink-0 sm:items-center">
        <% if @subscription.pro? %>
          <% if @subscription.status == 'cancelled' %>
            <%= button_to 'Возобновить', reactivate_dashboard_subscription_path, 
                method: :post,
                class: "inline-flex items-center rounded-md bg-purple-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500" %>
          <% else %>
            <%= button_to 'Отменить подписку', cancel_dashboard_subscription_path, 
                method: :post,
                data: { turbo_confirm: 'Вы уверены? Подписка будет действовать до конца оплаченного периода.' },
                class: "inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
          <% end %>
        <% else %>
          <%= link_to 'Улучшить до Pro', plans_dashboard_subscription_path, 
              class: "inline-flex items-center rounded-md bg-purple-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500" %>
        <% end %>
      </div>
    </div>
    
    <!-- Plan Features -->
    <div class="mt-6 border-t border-gray-200 pt-6">
      <h3 class="text-sm font-medium text-gray-900">Что включено:</h3>
      <ul class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
        <% if @subscription.pro? %>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">100 AI-токенов ежемесячно</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">Virtual Try-On (примерка)</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">Fashion Models</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">Неограниченный гардероб</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">Приоритетная поддержка</span>
          </li>
        <% else %>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">3 бонусных токена при регистрации</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">Базовый доступ к гардеробу</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-600">До 50 вещей в гардеробе</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-gray-300 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
            </svg>
            <span class="ml-3 text-sm text-gray-400">AI-функции недоступны</span>
          </li>
        <% end %>
      </ul>
    </div>
  </div>
</div>

<!-- Payment History -->
<div class="bg-white shadow rounded-xl overflow-hidden">
  <div class="px-6 py-5 border-b border-gray-200">
    <h2 class="text-lg font-semibold text-gray-900">История платежей</h2>
  </div>
  
  <% if @payment_history.any? %>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Дата
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Описание
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Сумма
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Статус
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @payment_history.each do |payment| %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= payment.created_at.strftime('%d.%m.%Y %H:%M') %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <% if payment.metadata.is_a?(Hash) && payment.metadata['plan'] %>
                  Подписка <%= payment.metadata['plan'] == 'pro_monthly' ? 'Pro Monthly' : 'Pro Yearly' %>
                <% else %>
                  Платёж за подписку
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(payment.amount / 100.0, unit: '₽', format: '%n %u') %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <% case payment.status %>
                <% when 'succeeded' %>
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                    Успешно
                  </span>
                <% when 'pending' %>
                  <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
                    Ожидание
                  </span>
                <% when 'failed' %>
                  <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                    Ошибка
                  </span>
                <% else %>
                  <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800">
                    <%= payment.status %>
                  </span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
      </svg>
      <h3 class="mt-2 text-sm font-semibold text-gray-900">Нет платежей</h3>
      <p class="mt-1 text-sm text-gray-500">История платежей пуста</p>
    </div>
  <% end %>
</div>
